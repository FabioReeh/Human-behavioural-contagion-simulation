<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: grid;
            grid-template-areas:
                "header"
                "parameters"
                "plot"
                "footer";
            gap: 20px;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        header {
            grid-area: header;
            text-align: center;
        }
        .parameters {
            grid-area: parameters;
            display: flex;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
        }
        .parameters label {
            display: flex;
            justify-content: space-between;
        }
        .parameters input {
            width: 100px;
            padding: 5px;
        }
        .parameters input.invalid {
            border: 2px solid red;
        }
        .plot {
            grid-area: plot;
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
        }
        .plot img {
            max-width: 100%;
            border: 1px solid #ccc;
            margin-top: 15px;
        }
        footer {
            grid-area: footer;
            text-align: center;
            font-size: 0.9em;
            color: #555;
        }
        .notice {
            color: red;
            font-weight: bold;
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"></script>
</head>
<body>
    <header>
        <h1>Agent Simulation</h1>
        <p>Simulate different behavioral contagion processes by selecting your parameters below.</p>
    </header>

    <section class="parameters">
        <label for="agents">
            Number of Agents: <span aria-hidden="true">(5-25)</span>
            <input type="number" id="agents" name="agents" min="5" max="25" step="1" required>
        </label>
        <label for="density">
            Density: <span aria-hidden="true">(0.80-1.20)</span>
            <input type="number" id="density" name="density" step="0.01" min="0.80" max="1.20" required>
        </label>
        <button id="simulate-button">Generate</button>
        <div id="notice" class="notice"></div>
    </section>

    <section class="plot">
        <h2>Simulation Results</h2>
        <button id="run-python-button">Run Simulation</button>
        <div id="plot-container"></div>
    </section>

    <footer>
        <p>&copy; 2024 Agent Simulation. All rights reserved.</p>
    </footer>

    <script>
        let allowedCombinations = {}; // Load dynamically from JSON.

        // Fetch combinations.json and initialize form
        fetch('combinations.json')
            .then(response => response.json())
            .then(data => {
                allowedCombinations = data;
                setInitialFormValues();
            })
            .catch(error => {
                document.getElementById('notice').textContent = `Error loading data: ${error.message}`;
            });

        // Set initial form values
        function setInitialFormValues() {
            const initialAgents = Object.keys(allowedCombinations)[0];
            document.getElementById('agents').value = initialAgents;
            document.getElementById('density').value = allowedCombinations[initialAgents][0];
        }

        // Add simulation button handler
        document.getElementById('simulate-button').addEventListener('click', function () {
            const agentsInput = document.getElementById('agents');
            const densityInput = document.getElementById('density');
            const notice = document.getElementById('notice');

            const agents = agentsInput.value;
            const density = parseFloat(densityInput.value).toFixed(2);

            if (!allowedCombinations[agents]) {
                agentsInput.classList.add('invalid');
                notice.textContent = `Invalid number of agents. Allowed values: ${Object.keys(allowedCombinations).join(', ')}.`;
                return;
            } else {
                agentsInput.classList.remove('invalid');
            }

            if (!allowedCombinations[agents].includes(density)) {
                densityInput.classList.add('invalid');
                notice.textContent = `Invalid density for ${agents} agents. Allowed values: ${allowedCombinations[agents].join(', ')}.`;
                return;
            } else {
                densityInput.classList.remove('invalid');
            }

            notice.textContent = '';
            runPythonSimulation(agents, density);
        });

        // Load and run external Python script
        async function runPythonSimulation(agents, density) {
            const pyodide = await loadPyodide();
            await pyodide.loadPackage(['matplotlib', 'numpy']);

            // Fetch the Python script
            const response = await fetch('plot_generator.py');
            const pythonCode = await response.text();

            // Load and run the Python script
            pyodide.runPython(pythonCode);

            // Call the Python function and display the result
            const plotBase64 = pyodide.runPython(`generate_plot(${agents}, ${density})`);
            const img = document.createElement('img');
            img.src = 'data:image/png;base64,' + plotBase64;

            const plotContainer = document.getElementById('plot-container');
            plotContainer.innerHTML = ''; // Clear previous plot
            plotContainer.appendChild(img);
        }
    </script>
</body>
</html>
