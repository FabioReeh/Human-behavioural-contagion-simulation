<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center; /* Center-align text */
        }
        form, table, .carousel {
            margin: 0 auto; /* Center the element */
        }
        label {
            display: block;
            margin-bottom: 8px;
        }
        input[type="number"], input[type="submit"] {
            margin-bottom: 20px;
        }
        table {
            width: auto; /* Let the table width adjust to its content */
            margin: 20px auto; /* Center the table */
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .carousel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .image-row {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        .image-row img {
            max-width: 100%;
            max-height: 500px;
        }
        .carousel-buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        .carousel-buttons button {
            padding: 5px 10px;
        }
        .agent-name {
            margin-top: 10px;
            font-weight: bold;
        }
        .notice {
            color: red;
            font-weight: bold;
        }
        .description {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
    </style>
    <!-- Include Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"></script>
</head>
<body>
    <h1>Agent Simulation</h1>
    <div class="description">This tool allows you to simulate different behavioural contagion processes. Select your parameters below to see the results.</div>

    <div id="combinations-table-container"></div> <!-- Table container for allowed combinations -->

    <form id="simulation-form">
        <label for="agents">Number of Agents:</label>
        <input type="number" id="agents" name="agents" min="5" max="25" step="1" required>

        <label for="density">Density:</label>
        <input type="number" id="density" name="density" step="0.001" min="0.80" max="1.20" required>
        <br>
        <input type="submit" value="Generate">
    </form>

    <div id="notice" class="notice"></div>

    <div class="carousel" id="carousel" style="display: none;">
        <div class="image-row">
            <img id="top-view-image" src="" alt="Top View">
            <img id="carousel-image" src="" alt="Front View">
        </div>
        <div class="carousel-buttons" id="carousel-buttons"></div>
        <div id="agent-name" class="agent-name"></div>
    </div>

    <!-- Section to display the Python plot -->
    <h2>Python Plot Example</h2>
    <button id="run-python-button">Run Python Script</button>
    <div id="plot-container"></div>

    <script>
        let allowedCombinations = {};

        // Load the combinations JSON file and display the table
        fetch('combinations.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load combinations.json');
                }
                return response.json();
            })
            .then(data => {
                allowedCombinations = data;
                displayCombinationsTable();
                setInitialFormValues();
            })
            .catch(error => {
                document.getElementById('combinations-table-container').innerHTML = `<div class="notice">Error: ${error.message}</div>`;
            });

        // Function to display the combinations table
        function displayCombinationsTable() {
            const container = document.getElementById('combinations-table-container');
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            const agentHeader = document.createElement('th');
            agentHeader.textContent = 'Number of Agents';
            const densityHeader = document.createElement('th');
            densityHeader.textContent = 'Allowed Densities';
            headerRow.appendChild(agentHeader);
            headerRow.appendChild(densityHeader);
            table.appendChild(headerRow);

            for (const [agents, densities] of Object.entries(allowedCombinations)) {
                const row = document.createElement('tr');
                const agentCell = document.createElement('td');
                agentCell.textContent = agents;
                const densityCell = document.createElement('td');
                densityCell.textContent = densities.join(', ');
                row.appendChild(agentCell);
                row.appendChild(densityCell);
                table.appendChild(row);
            }

            container.appendChild(table);
        }

        // Set initial form values based on the first valid combination
        function setInitialFormValues() {
            const initialAgents = Object.keys(allowedCombinations)[0];
            document.getElementById('agents').value = initialAgents;
            document.getElementById('density').value = allowedCombinations[initialAgents][0];
        }

        document.getElementById('simulation-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const agents = document.getElementById('agents').value;
            const density = parseFloat(document.getElementById('density').value).toFixed(2);

            const notice = document.getElementById('notice');
            const carousel = document.getElementById('carousel');
            const carouselImage = document.getElementById('carousel-image');
            const topViewImage = document.getElementById('top-view-image');
            const agentName = document.getElementById('agent-name');
            const carouselButtons = document.getElementById('carousel-buttons');

            let imageEntries = [];
            const folderName = `agents_${agents}_dens_${density}`;
            let imageCount = 50; // Adjust this number as needed
            let imagesTried = 0;

            if (!allowedCombinations[agents]) {
                notice.textContent = `Invalid number of agents. Allowed values: ${Object.keys(allowedCombinations).join(', ')}.`;
                carousel.style.display = 'none';
                return;
            }

            if (!allowedCombinations[agents].includes(density)) {
                notice.textContent = `Invalid density value for ${agents} agents. Allowed values: ${allowedCombinations[agents].join(', ')}.`;
                carousel.style.display = 'none';
                return;
            }

            notice.textContent = '';
            carousel.style.display = 'none';

            // Helper function to load a single image
            function loadImage(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = () => {
                        console.error(`Could not load image at ${url}`);
                        reject(new Error(`Failed to load ${url}`));
                    };
                    img.src = url;
                });
            }

            // Attempt to load all images (front and top) for each agent
            for (let i = 1; i <= imageCount; i++) {
                const frontPath = `images/${folderName}/agent${i}.png`;
                const topPath = `images_top_view/${folderName}/agent${i}.png`;

                Promise.all([loadImage(frontPath), loadImage(topPath)])
                    .then(([frontImg, topImg]) => {
                        const name = `Agent ${i}`;
                        imageEntries.push({
                            index: i,
                            name: name,
                            frontSrc: frontPath,
                            topSrc: topPath
                        });
                    })
                    .catch(() => {
                        // If any image for this agent fails, we do nothing for that agent
                    })
                    .finally(() => {
                        imagesTried++;
                        if (imagesTried === imageCount) {
                            finalizeImages();
                        }
                    });
            }

            function finalizeImages() {
                if (imageEntries.length === 0) {
                    notice.textContent = 'No images found for the selected combination.';
                    carousel.style.display = 'none';
                    return;
                }

                // Sort by index to ensure order from agent1 to agentN
                imageEntries.sort((a, b) => a.index - b.index);

                // Show the first image
                displayImage(0);
                buildImageButtons();
                carousel.style.display = 'block';
            }

            function displayImage(index) {
                const entry = imageEntries[index];
                carouselImage.src = entry.frontSrc;
                topViewImage.src = entry.topSrc;
                agentName.textContent = entry.name;
            }

            function buildImageButtons() {
                carouselButtons.innerHTML = '';
                // Create a button for each agent in order
                for (let i = 0; i < imageEntries.length; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = imageEntries[i].name;
                    btn.addEventListener('click', () => displayImage(i));
                    carouselButtons.appendChild(btn);
                }
            }
        });

        // Function to load Pyodide and run the Python code
        async function loadAndRunPython() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage(['matplotlib', 'numpy']);

            let response = await fetch('docs/plot_generator.py');
            if (!response.ok) {
                console.error('Failed to load script.py');
                return;
            }
            let code = await response.text();

            await pyodide.runPythonAsync(code);

            let img_base64 = pyodide.globals.get('img_base64');

            let img = document.createElement('img');
            img.src = 'data:image/png;base64,' + img_base64;

            const plotContainer = document.getElementById('plot-container');
            plotContainer.innerHTML = '';
            plotContainer.appendChild(img);
        }

        document.getElementById('run-python-button').addEventListener('click', loadAndRunPython);
    </script>
</body>
</html>

